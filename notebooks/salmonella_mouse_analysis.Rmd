---
title: "Salmonella mouse analysis"
output:
  html_notebook: default
---

Load libraries
```{r}
library(dplyr)
library(readr)
library(FluxBalanceAnalyzeR)
library(stringr)
library(tidyr)
library(purrr)
library(ggplot2)
library(magrittr)
library(forcats)
```
Helper functions
```{r}
optimize_and_minimize <- function(mod){
  res1 <- gurobi::gurobi(mod, params = list(OutputFlag=0))
  if(res1$status=='INFEASIBLE'){
    return(res1)
  }
  
  mod1 <- mod
  flux <- res1$x
  mod1$lb[flux > 0] <- 0
  mod1$ub[flux < 0] <- 0
  mod1$lb[mod$obj !=0] <- flux[mod$obj !=0]
  mod1$ub[mod$obj !=0] <- flux[mod$obj !=0]
  mod1$obj <- -sign(flux)
  
  res2 <- gurobi::gurobi(mod1, params = list(OutputFlag=0))
  res1$x <- res2$x
  return(res1)
}

find_fluxes_single <- function(reaction_table){
  res <- reaction_table %>%
    parse_reaction_table() %>%
    optimize_and_minimize()

  if('x' %in% names(res)){
    return(res$x)
  }else{
     return(0)
  }
}

# find_fluxes_average <- function(reaction_table){
#   map_df(1:10, function(x){rxns}, .id='sample') %>%
#     group_by(sample) %>%
#     sample_frac() %>%
#     by_slice(find_fluxes_single) %>%
#     
#   optimresults <- map(1, function(x){optimize_and_minimize(parse_reaction_table(sample_frac(reaction_table)))}) %>%
#     map(getElement, 'x') %>%
#     compact()
#   if(length(optimresults)>0){
#     optimresults %>%
#     map(data_frame) %>%
#     bind_cols() %>%
#     rowMeans(na.rm=TRUE)
#   }else{
#     return(0)
#   }
# }

find_fluxes <- find_fluxes_single

heatmap2ggplot <- function(x){
  rowlevels <- x %>% 
    dist() %>%
    hclust() %>%
    with(labels[order])
  
  collevels <- x %>% 
    t() %>%
    dist() %>%
    hclust() %>%
    with(labels[order])
    
  x %>%
    as.data.frame() %>%
    tibble::rownames_to_column() %>%
    gather(key = 'colname', value = 'value', -rowname) %>%
    mutate(colname = factor(colname, collevels),
           rowname = factor(rowname, rgene_associateowlevels)) %>%
    # group_by(colname) %>%
    # mutate(removeme = between(value,-0.1,0.1)) %>% filter(!removeme) %>% select(-removeme) %>%
    # ungroup %>%
    # group_by(rowname) %>%
    # mutate(removeme = between(value,-0.1,0.1)) %>% filter(!removeme) %>% select(-removeme) %>%
    # ungroup %>%
    ggplot(aes(x=colname, y=rowname, fill = value)) +
    geom_tile() +
    scale_fill_distiller(limits = c(-max(abs(x)), max(abs(x))), type='div', palette = 'BrBG')
}


trans_magnify <- function(left, right, zoom){
  
line <- function(x1,y1,slope){
  y <- function(x){(x-x1)*slope+y1}
  x <- function(y){(y-y1)/slope+x1}
  return(list(x=x,y=y))
}
  
  scales::trans_new('linear_magnifier',
                             transform = function(x){
                               beginning <- line(left,left,1)
                               middle <- line(left, beginning$y(left), zoom)
                               end <- line(right, middle$y(right), 1)
                               
                               ifelse(x<left, beginning$y(x),
                                      ifelse(between(x, left,right), middle$y(x),
                                             ifelse(x>right, end$y(x), NA)
                                             )
                                      )
                             },
                             inverse = function(x){
                               beginning <- line(left,left,1)
                               middle <- line(left, beginning$y(left), zoom)
                               end <- line(right, middle$y(right), 1)
                               
                               ifelse(x<beginning$y(left), beginning$x(x),
                                      ifelse(between(x, middle$y(left), middle$y(right)), middle$x(x),
                                             ifelse(x > end$y(right), end$x(x), NA)
                                             )
                                      )
                             }
                             )
}
```

Read in reaction table
```{r}
rxns <- read_tsv('../data/LT2_react.tsv') %>%
  select(abbreviation=`Rxn name`,
         equation=Formula,
         uppbnd=UB,
         lowbnd=LB,
         geneAssociation=`Gene-reaction association`,
         Subsystem,
         name = `Rxn description`
         ) %>%
  mutate(obj_coef=1*(abbreviation=='biomass_iRR1083')) %>%
  mutate(geneAssociation = str_replace_all(geneAssociation, 'and', '&'),
         geneAssociation = str_replace_all(geneAssociation, 'or', '|'))

```

Custom reaction bounds
```{r}
rxns <- rxns %>%
  mutate(lowbnd = ifelse(abbreviation=='EX_skm(e)',-10,lowbnd))
```

From reaction table, list all genes
```{r}
genes_in_model <- rxns$geneAssociation %>%
  str_split('[()|& ]+') %>%
  flatten_chr() %>%
  discard(is.na) %>%
  discard(~ str_length(.x)==0)
```

Map between STM style codes and gene names
```{r}
genes_mapping <- read_tsv('../data/LT2_genes.tsv')

gene_names_in_model <- genes_mapping %>%
  filter(Gene %in% genes_in_model) %>%
  getElement('Alias')
```

Select which group to use as the control. This will produce a wild type output.
```{r}
control <- 'Input'
```

Read in rna counts and preprocess them
```{r}
rnas <- inner_join(
  read_tsv('../data/seq_counts.tsv') %>%
    rename(Alias = Gene),
  genes_mapping %>%
    select(Alias,
           Gene)
) %>%
  filter(Gene %in% genes_in_model) %>%
  gather(measurement, count, -Locus, -Gene, -Product, -Alias) %>%
  separate(measurement, c('group', 'replicate'), '_') %>%
  mutate(replicate = str_c(group, '_', replicate)) %>%
  # next, remove experimental variance between replicates
  group_by(replicate) %>%
  mutate(count = log(count+1),
         count = count/mean(count)) %>%
  ungroup %>%
  # now, average and normalize groups against control
  group_by(Gene, group) %>%
  summarise(meancount = mean(count)) %>%
  spread(group, meancount) %>%
  ungroup %>%
  mutate(Group1 = Group1/.[[control]],
         Group2 = Group2/.[[control]],
         Group3 = Group3/.[[control]],
         Input = Input/.[[control]]) %>%
  gather('group', 'presence', -Gene) %>% 
      mutate(presence = qnorm(pnorm(presence, mean=1, sd=sd(presence)), mean=1, sd=0.1)) %T>%
  (function(x){print(x %>%
      ggplot(aes(x=presence, y=qnorm(rank(presence)/length(presence)))) +
      geom_point()
  )})
```

Project the gene expressions onto the fluxes
```{r}
models_with_expression <- rnas %>%
  group_by(group) %>%
  do(bind_rows(., data_frame(Gene=setdiff(genes_in_model, .$Gene), presence=NA, group=.$group[1]))) %>%
  by_slice(function(x){
    rxns %>%
      mutate(activation = FluxBalanceAnalyzeR::gene_eval(geneAssociation, x$Gene, x$presence))
  }) %>%
  unnest(.out)
```

adjust flux bounds in line with activation
```{r}
models_with_targets <- models_with_expression %>%
  group_by(group) %>%
  by_slice(function(x){
    x %>% mutate(baseflux = find_fluxes(x)) # this is useful if we want the flux bounds to be a function of the initial fluxes
  }) %>%
  unnest(.out) %>%
  #mutate(activation=1) %>% # for testing
  mutate(uppbnd = ifelse(is.na(activation), uppbnd, pmax(0, pmin(uppbnd, baseflux * activation * 1.1))),
         lowbnd = ifelse(is.na(activation), lowbnd, pmin(0, pmax(lowbnd, baseflux * activation * 0.9)))) %T>%
  (function(x){print(x %>%
                       filter(!(is.na(activation))) %>%
                       #filter(abs(baseflux)<900) %>%
                       ggplot(aes(x = baseflux)) + 
                       geom_ribbon(aes(ymin=lowbnd, ymax=uppbnd)) + 
                       geom_point(aes(y=baseflux), colour='blue')
  )})
```

calculate final fluxes
```{r}
results <- models_with_targets %>%
  group_by(group) %>%
  by_slice(function(x){
    x %>% 
      mutate(flux = find_fluxes(x))
  }) %>%
  unnest(.out) %T>%
  (. %>%
  filter(str_detect(abbreviation, 'iomass')) %>%
  select(group, abbreviation, flux) %>% 
  print
  )
```

Produce final figures
=====================

Prepare flux data
```{r}
results_analysed_3 <- results %>%
  # normalize by group biomass
  # group_by(group) %>%
  # mutate(propflux = flux / flux[abbreviation=='biomass_iRR1083']) %>%
  # ungroup %>%
  # normalize by typical reaction flux
  group_by(abbreviation) %>%
  mutate(
    baseflux = flux[group=='Input'],
    norm1 = ifelse(rep_along(flux, !near(baseflux,0,tol=0.00001)), flux/baseflux, NaN),
    norm2 = ifelse(rep_along(flux, !near(median(flux),0,tol=0.00001)), flux/median(flux), NA),
    norm3 = ifelse(rep_along(flux, !near(median(abs(flux)),0,tol=0.00001)), flux/median(abs(flux)), NA),
    norm4 = ifelse(rep_along(flux, !near(mean(abs(flux)),0,tol=0.00001)), flux/mean(abs(flux)), NA),
    norm5 = ifelse(rep_along(flux, near(flux,0,tol=0.00001)), 0, NA),
    normflux = coalesce(norm1, norm2, norm3, norm4, norm5)
  ) %>%
  select(-norm1, -norm2, -norm3, -norm4, -norm5) %>%
  ungroup %>%
  # prepare to filter out uninteresting
  group_by(group) %>%
  mutate(bmflux = normflux[abbreviation=='biomass_iRR1083']) %>%
  ungroup
```

Plot an overall horizontal summary
```{r}
horizontal_point_summary <- results_analysed_3 %>%
    filter(Subsystem!='Exchange') %>%
    group_by(abbreviation) %>%
    filter(!all(near(normflux, bmflux, tol=0.001)),
           !all(near(normflux, 0))) %>%
    ungroup %>%
    arrange(Subsystem,abbreviation, group) %>%
    mutate(abbreviation=fct_inorder(abbreviation)) %>%
    # plot
    ggplot(aes(x=normflux, y=abbreviation)) + 
    scale_x_continuous(labels=scales::percent, trans=trans_magnify(1.1,1.3,20)) +
    geom_point(aes(colour=group, shape=group), alpha=0.5) +
    labs(x='Normalized Flux', y='Reaction Abbreviation') +
    theme_bw() + 
    geom_tile(aes(width=0.1, x=max(normflux)*1.7, y=abbreviation, fill=letters[as.numeric(as.factor(Subsystem)) %% 8+1]), show.legend = FALSE) +
    geom_text(aes(x=max(normflux)*1.7, label = pathway, group=Subsystem), check_overlap=TRUE, data=(. %>% group_by(Subsystem) %>% mutate(pathway = ifelse(abbreviation==nth(abbreviation,round(n()/2)),Subsystem,NA))), hjust=1, alpha=0.5, size=2.5) +
    scale_fill_brewer(type='qual', palette = 'Set3')

  ggsave('../publication_images/horizontal_point_summary.png',plot=horizontal_point_summary)
  print(horizontal_point_summary)
```

Prepare data for heatmap by adding metabolite data
```{r}
rate_tables <- results_analysed_3 %>%
    group_by(abbreviation) %>%
    filter(!all(near(normflux, bmflux, tol=0.001)),
           !all(near(normflux, 0))) %>%
    ungroup %>%
    group_by(group) %>%
    by_slice(function(x){
        inner_join(x, expand_reactions(x)) %>%
            mutate(rate = flux * stoich / abs(stoich))
    }) %>%
    with(set_names(.out, group))
```

Plot heatmaps
```{r}
expand.grid(x=c('Group1','Group2','Group3'), y=c('Group1','Group2','Group3','Input'), stringsAsFactors = FALSE) %>%
  filter(x!=y) %>%
  invoke_rows(.d=., .f=function(x,y){
    (inner_join(rate_tables[[x]], rate_tables[[y]], by=c('abbreviation', 'met')) %>%
       mutate(diff = rate.x-rate.y) %>%
       group_by(abbreviation) %>%
       filter(max(abs(diff))>0.05) %>%
       ggplot(aes(x=abbreviation, y=met, fill=diff)) + 
       geom_tile() +
       scale_fill_gradient2(midpoint=0, low='blue', high='red') + 
       labs(x='Reaction', y='Metabolite', fill='Raw flux difference') +
       ggtitle(str_c(x, ' vs ', y)) +
       theme_bw() + 
       theme(axis.text.x = element_text(angle = 45, hjust = 1))
    ) %>%
      ggsave(paste0('../publication_images/heatmap_',x,'_vs_',y,'.png'),.)
  }
  )
```




